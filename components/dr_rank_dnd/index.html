<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      :root {
        --bg: #ffffff;
        --border: #d9d9d9;
        --border-hover: #9ca3af;
        --text: #111827;
        --muted: #6b7280;
        --drag-bg: #eff6ff;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", Tahoma, sans-serif;
        color: var(--text);
        background: transparent;
      }

      .list {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
      }

      .item {
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: var(--bg);
        padding: 0.45rem 0.6rem;
        user-select: none;
      }

      .item:hover {
        border-color: var(--border-hover);
      }

      .item.dragging {
        opacity: 0.6;
      }

      .drop-line {
        position: relative;
        height: 0.55rem;
        margin: 0.05rem 0;
      }

      .drop-line::before {
        content: "";
        position: absolute;
        left: 0;
        right: 0;
        top: 50%;
        transform: translateY(-50%);
        border-top: 2px solid transparent;
      }

      .drop-line.active::before {
        border-top-color: #2563eb;
      }

      .drop-line.active::after {
        content: "";
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 7px;
        height: 7px;
        border-radius: 999px;
        background: #2563eb;
        left: 0;
      }

      .handle {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 1.65rem;
        height: 1.65rem;
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--muted);
        background: #f9fafb;
        font-weight: 700;
        letter-spacing: 0.02em;
        cursor: grab;
        flex-shrink: 0;
      }

      .handle:active {
        cursor: grabbing;
      }

      .content {
        display: flex;
        flex-direction: column;
        min-width: 0;
        gap: 0.15rem;
      }

      .rank {
        min-width: 1.4rem;
        text-align: right;
        color: var(--muted);
        font-size: 0.88rem;
      }

      .label {
        font-size: 0.9rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .subtitle {
        font-size: 0.78rem;
        color: var(--muted);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .empty {
        font-size: 0.85rem;
        color: var(--muted);
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script>
      const BACK_MSG = {
        COMPONENT_READY: "streamlit:componentReady",
        SET_COMPONENT_VALUE: "streamlit:setComponentValue",
        SET_FRAME_HEIGHT: "streamlit:setFrameHeight",
      };
      const FRONT_MSG = {
        RENDER: "streamlit:render",
      };
      const API_VERSION = 1;

      let items = [];
      let dragIndex = null;
      let insertionIndex = null;

      const root = document.getElementById("root");
      let dropLineElements = [];

      function sendMessage(type, data = {}) {
        window.parent.postMessage(
          {
            isStreamlitMessage: true,
            type,
            ...data,
          },
          "*"
        );
      }

      function setFrameHeight() {
        const height = document.documentElement.scrollHeight || document.body.scrollHeight || 0;
        sendMessage(BACK_MSG.SET_FRAME_HEIGHT, { height });
      }

      function setComponentValue(value) {
        sendMessage(BACK_MSG.SET_COMPONENT_VALUE, { value });
      }

      function normalizeItems(raw) {
        if (!Array.isArray(raw)) {
          return [];
        }
        return raw
          .map((item) => {
            if (item && typeof item === "object") {
              const id = String(item.id || "");
              if (!id) {
                return null;
              }
              return {
                id,
                label: String(item.label || id),
                subtitle: String(item.subtitle || ""),
              };
            }
            const text = String(item || "");
            if (!text) {
              return null;
            }
            return {
              id: text,
              label: text,
              subtitle: "",
            };
          })
          .filter(Boolean);
      }

      function reorder(fromIndex, toIndex) {
        if (fromIndex == null || toIndex == null) {
          return;
        }
        const next = [...items];
        const moved = next.splice(fromIndex, 1)[0];
        let insertAt = toIndex;
        if (insertAt > fromIndex) {
          insertAt -= 1;
        }
        if (insertAt < 0) {
          insertAt = 0;
        }
        if (insertAt > next.length) {
          insertAt = next.length;
        }
        next.splice(insertAt, 0, moved);
        if (next.length === items.length && next.every((item, idx) => item.id === items[idx].id)) {
          return;
        }
        items = next;
        render();
        setComponentValue(items.map((item) => item.id));
      }

      function setInsertionLine(index) {
        if (insertionIndex === index) {
          return;
        }
        insertionIndex = index;
        dropLineElements.forEach((line, idx) => {
          if (!line) return;
          if (idx === insertionIndex) {
            line.classList.add("active");
          } else {
            line.classList.remove("active");
          }
        });
      }

      function clearInsertionLine() {
        insertionIndex = null;
        dropLineElements.forEach((line) => {
          if (line) {
            line.classList.remove("active");
          }
        });
      }

      function render() {
        root.innerHTML = "";
        dropLineElements = [];
        const list = document.createElement("div");
        list.className = "list";

        if (items.length === 0) {
          const empty = document.createElement("div");
          empty.className = "empty";
          empty.textContent = "No selected weeks";
          list.appendChild(empty);
          root.appendChild(list);
          setFrameHeight();
          return;
        }

        const firstLine = document.createElement("div");
        firstLine.className = "drop-line";
        dropLineElements.push(firstLine);
        list.appendChild(firstLine);

        items.forEach((entry, idx) => {
          const item = document.createElement("div");
          item.className = "item";

          const handle = document.createElement("div");
          handle.className = "handle";
          handle.setAttribute("draggable", "true");
          handle.textContent = "\u2630";

          const rank = document.createElement("span");
          rank.className = "rank";
          rank.textContent = `${idx + 1}.`;

          const content = document.createElement("div");
          content.className = "content";

          const value = document.createElement("span");
          value.className = "label";
          value.textContent = entry.label;

          const subtitle = document.createElement("span");
          subtitle.className = "subtitle";
          subtitle.textContent = entry.subtitle || "";

          content.appendChild(value);
          if (entry.subtitle) {
            content.appendChild(subtitle);
          }

          item.appendChild(handle);
          item.appendChild(rank);
          item.appendChild(content);

          handle.addEventListener("dragstart", (event) => {
            dragIndex = idx;
            item.classList.add("dragging");
            if (event.dataTransfer) {
              event.dataTransfer.effectAllowed = "move";
              event.dataTransfer.setData("text/plain", String(idx));
            }
          });

          handle.addEventListener("dragend", () => {
            dragIndex = null;
            item.classList.remove("dragging");
            clearInsertionLine();
          });

          item.addEventListener("dragover", (event) => {
            event.preventDefault();
            const rect = item.getBoundingClientRect();
            const before = event.clientY < rect.top + rect.height / 2;
            setInsertionLine(before ? idx : idx + 1);
          });

          item.addEventListener("dragleave", () => {});

          item.addEventListener("drop", (event) => {
            event.preventDefault();
            reorder(dragIndex, insertionIndex);
            clearInsertionLine();
          });

          list.appendChild(item);

          const line = document.createElement("div");
          line.className = "drop-line";
          line.addEventListener("dragover", (event) => {
            event.preventDefault();
            setInsertionLine(idx + 1);
          });
          line.addEventListener("drop", (event) => {
            event.preventDefault();
            reorder(dragIndex, idx + 1);
            clearInsertionLine();
          });
          dropLineElements.push(line);
          list.appendChild(line);
        });

        list.addEventListener("dragover", (event) => {
          event.preventDefault();
        });
        list.addEventListener("drop", (event) => {
          event.preventDefault();
          reorder(dragIndex, insertionIndex);
          clearInsertionLine();
        });

        root.appendChild(list);
        if (insertionIndex != null) {
          setInsertionLine(insertionIndex);
        }
        setFrameHeight();
      }

      window.addEventListener("message", (event) => {
        const message = event.data;
        if (!message || message.type !== FRONT_MSG.RENDER) {
          return;
        }
        const args = message.args || {};
        items = normalizeItems(args.items);
        render();
      });

      sendMessage(BACK_MSG.COMPONENT_READY, { apiVersion: API_VERSION });
      setFrameHeight();
    </script>
  </body>
</html>
